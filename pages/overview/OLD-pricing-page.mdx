import Latex from "react-latex-next";
import StorageCostChart from "@/components/StorageCostChart";
import { Tooltip } from "react-tooltip";
import Formula from "@/components/Formula";
import UserFeeFormula from "@/components/UserFeeFormula";

<Tooltip
	id="kryders-law"
	className="irys-tooltip-styles"
	anchorSelect="#kryders-law"
	html="Kryder's Law states that the storage density of hard drives<br/>increases exponentially over time, similar to Moore's Law."
	style={{ backgroundColor: "#FF8451", color: "#000000" }}
/>

<Tooltip
	id="moores-law"
	className="irys-tooltip-styles"
	anchorSelect="#moores-law"
	html="Moore's Law observes that the number of transistors<br/>on a microchip doubles approximately every two years."
	style={{ backgroundColor: "#FF8451", color: "#000000" }}
/>

# Token Price Adjustments

## Example Pricing Model Calculations

Given the following pricing parameters:

| Parameter                        | Value     |
| -------------------------------- | --------- |
| Annualized Storage Cost (per GB) | $0.01     |
| Number of Replicas               | 10        |
| Safe Minimum Time                | 200 years |
| Decay Rate                       | 1%        |

This is how to calculate the price of storage in USD:

<Formula />

Therefore, the total cost of storing a single replica of 1GB for 200 years, with a continuous annual decay rate of 1%, is approximately $0.8647.

This results in a storage cost of **$8.65** per GB of permanent data ($0.8647×10≈$8.65).

### Compute User Fee

Let's say a user would like to store 200MB at time t with the following parameters.

<UserFeeFormula />

# OLD

# Irys Pricing Model

## TL; DR

- Accurate storage pricing is crucial for decentralized networks, requiring detailed cost analysis across multiple factors.
- **Annualized Storage Cost**: Includes drive cost, capacity, failure rate, power consumption, and power cost.
- **Power Consumption**: Factors in workload, read vs. idle time, power efficiency, and annual operation hours.
- **Cost per GB**: $0.011 per GB annually based on a 16TB drive costing $182 per year.
- **Decay Rate**: Assumes 1% annual decline in storage costs due to technological advancements.
- **Safe Minimum Time**: Ensures long-term storage viability, considering replicas, years of storage, safety margins, and cost declines.

## Annualized Storage Cost

The annualized cost of storing 1GB of data is determined by several contributing factors:

- Upfront cost of purchasing a storage drive
- The storage capacity of the drive in GB
- The annualized failure rate of the drive
- Power consumption of the drive under expected workloads
- Cost of power

For the purpose of this specification, we will consider a representative 16TB drive typically found in datacenter workloads in 2024.

### Power consumption

To calculate the annual power consumption, we take into account the mining workload, the expected time the drive spends reading data versus idling, its power efficiency in converting AC to DC power, and the hours of operation in a year.

<div className="mt-5 break-normal w-full text-xs border border-gray-400">
	<div className="grid grid-cols-10 border-b bg-slate-800">
		<div className="col-span-1 border-r">Operation</div>
		<div className="col-span-1 border-r">Operation Power Consumpt- ion</div>
		<div className="col-span-1 border-r">Power Efficiency</div>
		<div className="col-span-1 border-r">Transfer Rate (Reads)</div>
		<div className="col-span-1 border-r">AC Power Consumpt- ion</div>
		<div className="col-span-1 border-r">Operation Annual Share</div>
		<div className="col-span-1 border-r">Hours in a Year</div>
		<div className="col-span-1 border-r">Hours of Operation per year</div>
		<div className="col-span-1 border-r">Hours Per Day</div>
		<div className="col-span-1 border-r">Annual HDD AC Power Consumpt- ion</div>
	</div>
	<div className="grid grid-cols-10 border-b">
		<div className="col-span-1 border-r">R/W</div>
		<div className="col-span-1 border-r">6.50W</div>
		<div className="col-span-1 border-r">0.7</div>
		<div className="col-span-1 border-r">269MB/s</div>
		<div className="col-span-1 border-r">9.29W</div>
		<div className="col-span-1 border-r">80%</div>
		<div className="col-span-1 border-r">8760</div>
		<div className="col-span-1 border-r">7008</div>
		<div className="col-span-1 border-r">19.20 hr</div>
		<div className="col-span-1 border-r">65.07kWh</div>
	</div>
	<div className="grid grid-cols-10 border-b">
		<div className="col-span-1 border-r">Idle</div>
		<div className="col-span-1 border-r">5.60W</div>
		<div className="col-span-1 border-r">0.7</div>
		<div className="col-span-1 border-r">-</div>
		<div className="col-span-1 border-r">8.00W</div>
		<div className="col-span-1 border-r">20%</div>
		<div className="col-span-1 border-r">8760</div>
		<div className="col-span-1 border-r">1752</div>
		<div className="col-span-1 border-r">4.80 hr</div>
		<div className="col-span-1 border-r">14.02kWh</div>
	</div>
	<div className="grid grid-cols-10 border-b">
		<div className="col-span-7"></div>
		<div className="col-span-2 border-r text-right pr-2">Total Annual AC Consumption</div>
		<div className="col-span-1 border-r">79.09kWh</div>
	</div>
	<div className="grid grid-cols-10 border-b border-gray-400">
		<div className="col-span-7"></div>
		<div className="col-span-2 border-r text-right pr-2">Total Annual Data Transferred</div>
		<div className="col-span-1 border-r">6,472TiB</div>
	</div>
	<div className="grid grid-cols-10 border-gray-400 bg-slate-800">
		<div className="col-span-1 border-r"></div>
		<div className="col-span-1 border-r">Annualized Failure Rate</div>
		<div className="col-span-1 border-r">Drive Price</div>
		<div className="col-span-1 border-r">Drives In Datacenter</div>
		<div className="col-span-1 border-r">Drives Replaced</div>
		<div className="col-span-1 border-r">Replace- ment Costs</div>
		<div className="col-span-1 border-r">Annual kWh Consumed</div>
		<div className="col-span-1 border-r">Annual Energy Cost</div>
		<div className="col-span-1 border-r">Annual Operation Expenses</div>
		<div className="col-span-1 border-r">Annual Cost Per Drive</div>
	</div>
	<div className="grid grid-cols-10 border-b border-t border-gray-400">
		<div className="col-span-1 border-r">Annualized cost</div>
		<div className="col-span-1 border-r">1.40%</div>
		<div className="col-span-1 border-r">$169.99</div>
		<div className="col-span-1 border-r">100</div>
		<div className="col-span-1 border-r">1.4</div>
		<div className="col-span-1 border-r">$237.99</div>
		<div className="col-span-1 border-r">7,909kWh</div>
		<div className="col-span-1 border-r">$1,001</div>
		<div className="col-span-1 border-r">$18,238</div>
		<div className="col-span-1 border-r">$182</div>
	</div>
	<div className="grid grid-cols-10 border-gray-400">
		<div className="col-span-8"></div>
		<div className="col-span-1 border-r text-right pr-2">Cost of Power</div>
		<div className="col-span-1">12.66 ¢/kWh</div>
	</div>
</div>

By combining the annualized power consumption with the annualized HDD failure rate (as reported by [BackBlaze](https://www.backblaze.com/blog/backblaze-drive-stats-for-q1-2023/)), the current drive price, and the cost of power (which is readily available in most developed countries), we arrive at the annualized cost of operating a representative HDD storing data on the network.

Based on these factors, the annualized cost of mining and operating a 16TB drive is estimated to be $182. Given that a 16TB drive contains 16,384GB, the annualized cost of storing 1GB is calculated as follows:

<div className="flex flex-col justify-center items-center mt-5">
	<div className="flex flex-col justify-center border border-gray-400 px-10">
		<p className="px-4 py-2 bg-slate-800 rounded-xl w-full flex justify-center"> Annualized cost per GB</p>
		<Latex className="-mb-2">{`$$\\text{Cost to store 16TB} = \\$182$$`}</Latex>
		<Latex className="-mb-2">{`$$16TB = 16,384GB$$`}</Latex>
		<Latex>{`$$\\$182 \\div 16,384 = \\$0.01110839844$$`}</Latex>
	</div>
</div>

This annualized cost per GB will serve as a key input for the permanent storage pricing model.

## Annualized Decay Rate

The **decay rate** represents the annual decrease in storage costs due to technological advancements. Historically, storage density improvements have followed an exponential trend, as described by <a className="underline decoration-dashed" id="kryders-law">Kryder's Law</a>, which outpaced <a className="underline decoration-dashed" id="moores-law">Moore's Law</a> in the early 2000s. Although the rate of improvement has slowed in recent years, it still remains significant at around 28% annually.

To ensure the pricing model is both accessible and sustainable, Irys assumes a conservative 1% average annual decline in storage costs over the next 200 years. This approach allows for the extension of the purchasing power of the upfront payment in the event that observed (actual) storage cost declines exceed the assumed rate.

This leads to the following exponential decay formula to determine the cost of storing a single copy of 1GB of data over the next 200 years.

<div className="mt-5">
	<div className="grid grid-cols-[1fr_6fr_6fr] gap-2 border border-gray-400 p-4 ">
		<div className="col-span-3 px-4 py-2 bg-slate-800 rounded-xl text-white">
			<Latex>{`$$\\text{Total Cost} = C_0 \\times \\left( \\frac{1 - (1 - \\text{decay rate})^n}{\\text{decay rate}} \\right)$$`}</Latex>
		</div>
		<div className="col-span-3 px-4 py-2 text-white ">
			<div>**C0​** = the initial annual cost of storing 1 GB.</div>
			<div>**decay rate** = the annual rate of decline in storage costs.</div>
			<div>**n** = the number of years of safe minimum time.</div>
		</div>
		<div className="col-span-3 px-4 py-2 text-white ">
			<StorageCostChart />
		</div>
	</div>
</div>

## Safe Minimum Time

The safe minimum time is a crucial concept in the permanent storage pricing model, as it represents the fixed period for which users pay to store their data. Determining an appropriate safe minimum time involves considering several key factors:

1. **Minimum Number of Replicas**: To ensure fault tolerance and data durability, the protocol must maintain a minimum number of data replicas. The safe minimum time should be sufficient to cover the storage costs for these replicas.
2. **Years of Storage**: The protocol must determine the number of years for which miners should be paid to maintain the data replicas. This duration should be long enough to provide users with confidence in the permanence of their data.
3. **Safety Margins**: The pricing model incorporates safety margins to account for potential fluctuations in storage costs and other uncertainties. These margins help ensure that the upfront payment remains sufficient to cover storage costs over the safe minimum time.
4. **Storage Cost Declines**: The pricing model takes into account the expected declines in storage costs over time due to technological advancements. By assuming a conservative rate of decline, the model ensures that the safe minimum time remains viable even if cost reductions slow down.

The interplay of these factors results in a safe minimum time that provides users with a high degree of assurance that their data will remain permanently stored. Any declines in storage costs that exceed the conservative assumptions of the pricing model will effectively extend the duration for which the upfront payment can fund storage. In most cases, this results in a storage term that can span thousands of years, further reinforcing the permanence of the data stored on the protocol.

## Example Pricing

Given the following pricing parameters:

| Parameter                        | Value     |
| -------------------------------- | --------- |
| Annualized Storage Cost (per GB) | $0.01     |
| Number of Replicas               | 10        |
| Safe Minimum Time                | 200 years |
| Decay Rate                       | 1%        |

This is how to calculate the price of storage in USD:

<Formula />

Therefore, the total cost of storing a single replica of 1GB for 200 years, with a continuous annual decay rate of 1%, is approximately $0.8647.

This results in a storage cost of **$8.65** per GB of permanent data ($0.8647×10≈$8.65).

### Compute User Fee

Let's say a user would like to store 200MB at time t with the following parameters.

<div className="mt-5">
  <div className="grid grid-cols-[1fr_6fr_6fr] gap-2 border border-gray-400 p-4">
    <div className="col-span-3 flex justify-center px-4 py-2 bg-slate-800 rounded-xl text-white">
      <table className="table-auto border border-gray-400">
        <thead>
          <tr className="bg-slate-800">
            <th className="border px-4 py-2">Parameter</th>
            <th className="border px-4 py-2">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td className="border px-4 py-2">Cost to store 1GB (10 replicas, 200y)</td>
            <td className="border px-4 py-2">$8.65</td>
          </tr>
          <tr>
            <td className="border px-4 py-2">Storage Requested</td>
            <td className="border px-4 py-2">200MB</td>
          </tr>
          <tr>
            <td className="border px-4 py-2">$IRYS Token Price</td>
            <td className="border px-4 py-2">$1.09</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div className="flex items-center justify-center bg-[#FF8451] rounded-full text-xl m-2 text-white w-10 h-10 ">1</div>
    <div className="flex items-start border-b border-t">
      Determine the Ratio of Storage Requested to 1GB of Storage
    </div>
    <div className="flex flex-col items-start h-full border-b border-t">
      <Latex>{`$$= \\frac{\\text{Storage requested}}{\\text{1 GB}}$$`}</Latex>
      <Latex>{`$$= \\frac{200}{1024}$$`}</Latex>
      <Latex>{`$$= 0.1953125$$`}</Latex>
    </div>

    <div className="flex items-center justify-center bg-[#FF8451] rounded-full text-xl m-2 text-white w-10 h-10">2</div>
    <div className="flex items-start border-b">
      Determine the USD fee for Storage Requested using the Storage Ratio
    </div>
    <div className="flex flex-col items-start h-full  border-b">
      <Latex>{`$$= \\text{cost to store 1GB} \\times \\text{Storage Ratio}$$`}</Latex>
      <Latex>{`$$= 8.65 \\times 0.1953125$$`}</Latex>
      <Latex>{`$$= 1.689453125 = 1.69$$`}</Latex>
    </div>

    <div className="flex items-center justify-center bg-[#FF8451] rounded-full text-xl m-2 text-white w-10 h-10">3</div>
    <div className="flex items-start border-b">
      Denominate the USD fee in $IRYS using the $IRYS Token
    </div>
    <div className="flex flex-col items-start h-full border-b">
      <Latex>{`$$= \\frac{\\text{USD fee}}{\\text{\\$IRYS Token Price}}$$`}</Latex>
      <Latex>{`$$= \\frac{1.69}{1.09}$$`}</Latex>
      <Latex>{`$$= 1.5504587156 = 1.55 \\text{\\$IRYS}$$`}</Latex>
    </div>

    <div className="flex items-center justify-center bg-[#FF8451] rounded-full text-xl m-2 text-white w-10 h-10">4</div>
    <div className="flex items-start">
    		The protocol adds an additional 5% to the network fee for the reward paid to the miner that includes the transaction in a block.
    </div>
    <div className="flex flex-col items-start h-full">
      <Latex>{`$$= \\text{Network fee} + 5\\%$$`}</Latex>
      <Latex>{`$$= 1.55 \\times 1.05$$`}</Latex>
      <Latex>{`$$= 1.6275$$`}</Latex>
      <Latex>{`$$= 1.63 \\text{\\$IRYS}$$`}</Latex>
    </div>

  </div>
</div>

## Irys Protocol Mechanisms

The pricing model, although fixed and deterministically calculable, relies on two independent (or external) variables: the annual cost of storing 1 GB in any given year and the current USD/$IRYS price. To account for these externalities, the protocol employs the following mechanisms:

### Price Adjustment Interval

Like Bitcoin and other PoW chains, Irys utilizes an Adjustment Interval to track factors external to the chain. In PoW chains, this mechanism is used to track the passage of time, which is independent of block production. Each block includes a timestamp that must fall within a given range of possible times to be considered valid. In Bitcoin's case, a Difficulty adjustment occurs every 2016 blocks (roughly 14 days). During this adjustment, the protocol examines the time taken to produce the last 2016 blocks and compares it to the expected time. Based on this delta, the network's difficulty setting is adjusted higher or lower to increase or decrease the average block production time. This timekeeping mechanism is crucial, as a consistent block time is how the protocol manages its monetary policy around token emissions.

Irys employs a similar Adjustment Interval mechanism to track the USD/$IRYS price, which is external to the protocol. The Adjustment Interval for $IRYS price tracking occurs approximately once every hour (measured in blocks). At each interval, the protocol calculates the Exponential Moving Average (EMA) of the USD/$IRYS prices recorded in the blocks over the last 8 adjustment intervals, giving more weight to recent prices. The EMA smooths out price volatility while prioritizing recent data, providing a balance between protection from volatility and accuracy.

The price adjustment is constrained to fall within a range of +/- 0.25% to 5% to balance responsiveness and volatility mitigation. The new $IRYS price takes effect at the block height of the next Adjustment Interval, providing miners with a full interval to prepare for the change and quote the correct storage price to users.

Unlike tracking timestamps, which are relatively predictable and reliable once a computer's clock is configured, tracking the USD price of $IRYS introduces an element of risk for block producers, as they must rely on external parties to report the token price.

To mitigate these risks, the protocol employs several mechanisms:

1. **Safe Ranges for Price Fluctuations**: The protocol defines safe ranges within which the reported $IRYS price must fall to be considered valid.
2. **Vote of Confidence**: Block producers express their confidence in the current $IRYS price by simply including current EMA price in the blocks they produce (no need for external oracles).
3. **External Price Oracles**: Block producers can select from one or more external price oracles for $IRYS and post prices within the predefined safe ranges.
4. **Irys Foundation Oracle**: Block producers have the option to subscribe to the $IRYS price provided by the Irys Foundation's oracle.

By incorporating these risk mitigation mechanisms, the protocol ensures that the $IRYS token can experience price volatility while maintaining a relatively stable USD price for storage
